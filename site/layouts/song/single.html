{{ define "main" }}
  {{ $song := dict }}
  {{ with .Params.songJson }}
    {{ $song = . | transform.Unmarshal }}
  {{ end }}

  {{ $bg := "" }}
  {{ with $song.background }}
    {{ $res := $.Resources.GetMatch . }}
    {{ with $res }}
      {{ $bg = .RelPermalink }}
    {{ end }}
  {{ end }}

  {{/* cover image (thumbnail) for PDF-like header */}}
  {{ $images := where (.Resources.ByType "image") "Params.hidden" "ne" true }}
  {{ $covers := where (.Resources.ByType "image") "Params.cover" "eq" true }}
  {{ $cover := (index $covers 0) | default (index $images 0) }}
  {{ $coverThumb := "" }}
  {{ with $cover }}
    {{ $coverThumb = .Filter (slice images.AutoOrient (images.Process "fit 220x220")) }}
  {{ end }}

  <section class="songbook-song {{ if $bg }}songbook-song--has-bg{{ end }}" {{ if $bg }}style="--songbook-bg: url('{{ $bg }}');"{{ end }} data-songbook-song>
    <div class="songbook-page">
      <header class="songbook-header">
        {{ with $coverThumb }}
          <img class="songbook-header__cover" src="{{ .RelPermalink }}" width="{{ .Width }}" height="{{ .Height }}" alt="{{ $.Title }} cover" />
        {{ end }}
        <div class="songbook-header__meta">
          <h1 class="songbook-header__title">{{ .Title }}</h1>
          {{ with $song.info }}
            <div class="songbook-header__info">
              {{ range . }}
                <div class="songbook-header__info-line">{{ . }}</div>
              {{ end }}
            </div>
          {{ end }}
        </div>
      </header>

      <div class="songbook-toolbar">
        <a class="songbook-btn" href="{{ "/" | relURL }}">Back to Index</a>
        <div class="songbook-btn-group" role="group" aria-label="Notation mode">
          <button class="songbook-btn songbook-btn--ghost" type="button" data-notation-mode="indian">Indian</button>
          <button class="songbook-btn songbook-btn--ghost" type="button" data-notation-mode="western">Western</button>
          <button class="songbook-btn songbook-btn--ghost" type="button" data-notation-mode="both">Both</button>
        </div>
      </div>

      <div class="songbook-body">
      {{ range ($song.sections | default (slice)) }}
        <section class="songbook-section">
          <h2 class="songbook-section__title">{{ .name }}</h2>
          <div class="songbook-two-col">
            {{ range (.lines | default (slice)) }}
              <div class="songbook-line">
                <div class="songbook-lyric">{{ .lyrics }}</div>
                <div class="songbook-notation songbook-notation--indian notation-indian">{{ .indian }}</div>
                {{ with .western }}
                  <div class="songbook-notation songbook-notation--western notation-western">{{ . }}</div>
                {{ end }}
              </div>
            {{ end }}
          </div>
        </section>
      {{ end }}
      </div>
    </div>
  </section>

  {{ with .Content }}
    <!-- Keep for optional notes; usually empty for generated songs -->
    <section class="prose">
      {{ . }}
    </section>
  {{ end }}
{{ end }}

